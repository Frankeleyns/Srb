# 01-后台接口工程搭建



## 基础框架结构

**Srb：** 总工程，父依赖

**srb-common：**工程通用包依赖，其他的工程都引入这个通用工程 ( 非微服务 )

**service-base：**持久层的依赖 ( 非微服务 )

**service-core：**核心业务 ( 具体的微服务 )

![基础框架结构图](./img/01/architecture.png)





## 一、创建父工程 Srb



### 1. 新建一个文件夹 取名 Srb

![](./img/01/1.png)





### 2. 添加一个pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.frankeleyn</groupId>
    <artifactId>srb</artifactId>
    <version>1.0</version>

    <!-- 打包方式 -->
    <packaging>pom</packaging>


    <!-- 配置 Spring Boot 版本 -->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.4.RELEASE</version>
    </parent>


    <!-- 配置 pom 依赖版本号 -->
    <properties>
        <java.version>1.8</java.version>
        <spring-cloud-alibaba.version>2.2.2.RELEASE</spring-cloud-alibaba.version>
        <spring-cloud.version>Hoxton.SR8</spring-cloud.version>
        <mybatis-plus.version>3.4.1</mybatis-plus.version>
        <velocity.version>2.0</velocity.version>
        <swagger.version>2.9.2</swagger.version>
        <swagger-bootstrap-ui.version>1.9.2</swagger-bootstrap-ui.version>
        <commons-lang3.version>3.9</commons-lang3.version>
        <commons-fileupload.version>1.3.1</commons-fileupload.version>
        <commons-io.version>2.6</commons-io.version>
        <alibaba.easyexcel.version>2.1.1</alibaba.easyexcel.version>
        <apache.xmlbeans.version>3.1.0</apache.xmlbeans.version>
        <fastjson.version>1.2.28</fastjson.version>
        <gson.version>2.8.2</gson.version>
        <json.version>20170516</json.version>
        <aliyun-java-sdk-core.version>4.3.3</aliyun-java-sdk-core.version>
        <aliyun-sdk-oss.version>3.10.2</aliyun-sdk-oss.version>
        <jodatime.version>2.10.1</jodatime.version>
        <jwt.version>0.7.0</jwt.version>
        <httpclient.version>4.5.1</httpclient.version>
    </properties>

    <!-- 配置 pom 依赖-->
    <dependencyManagement>
        <dependencies>

            <!--Spring Cloud-->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <!--Spring Cloud Alibaba-->
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>${spring-cloud-alibaba.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <!--mybatis-plus-->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            <!--mybatis-plus 代码生成器-->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-generator</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            <!-- Mybatis Plus 代码生成器模板引擎,  -->
            <dependency>
                <groupId>org.apache.velocity</groupId>
                <artifactId>velocity-engine-core</artifactId>
                <version>${velocity.version}</version>
            </dependency>

            <!--swagger-->
            <dependency>
                <groupId>io.springfox</groupId>
                <artifactId>springfox-swagger2</artifactId>
                <version>${swagger.version}</version>
            </dependency>
            <!--swagger ui-->
            <dependency>
                <groupId>io.springfox</groupId>
                <artifactId>springfox-swagger-ui</artifactId>
                <version>${swagger.version}</version>
            </dependency>
            <!--swagger-bootstrap-ui-->
            <dependency>
                <groupId>com.github.xiaoymin</groupId>
                <artifactId>swagger-bootstrap-ui</artifactId>
                <version>${swagger-bootstrap-ui.version}</version>
            </dependency>

            <!--commons-lang3-->
            <dependency>
                <groupId>org.apache.commons</groupId>
                <artifactId>commons-lang3</artifactId>
                <version>${commons-lang3.version}</version>
            </dependency>

            <!--文件上传-->
            <dependency>
                <groupId>commons-fileupload</groupId>
                <artifactId>commons-fileupload</artifactId>
                <version>${commons-fileupload.version}</version>
            </dependency>

            <!--commons-io-->
            <dependency>
                <groupId>commons-io</groupId>
                <artifactId>commons-io</artifactId>
                <version>${commons-io.version}</version>
            </dependency>

            <!--excel解析-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>easyexcel</artifactId>
                <version>${alibaba.easyexcel.version}</version>
            </dependency>
            <!--excel解析依赖-->
            <dependency>
                <groupId>org.apache.xmlbeans</groupId>
                <artifactId>xmlbeans</artifactId>
                <version>${apache.xmlbeans.version}</version>
            </dependency>

            <!--json-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>${fastjson.version}</version>
            </dependency>
            <dependency>
                <groupId>org.json</groupId>
                <artifactId>json</artifactId>
                <version>${json.version}</version>
            </dependency>
            <dependency>
                <groupId>com.google.code.gson</groupId>
                <artifactId>gson</artifactId>
                <version>${gson.version}</version>
            </dependency>

            <!--阿里云SDK远程调用-->
            <dependency>
                <groupId>com.aliyun</groupId>
                <artifactId>aliyun-java-sdk-core</artifactId>
                <version>${aliyun-java-sdk-core.version}</version>
            </dependency>

            <!--阿里云文件管理-->
            <dependency>
                <groupId>com.aliyun.oss</groupId>
                <artifactId>aliyun-sdk-oss</artifactId>
                <version>${aliyun-sdk-oss.version}</version>
            </dependency>

            <!--日期时间工具-->
            <dependency>
                <groupId>joda-time</groupId>
                <artifactId>joda-time</artifactId>
                <version>${jodatime.version}</version>
            </dependency>

            <!--jwt工具-->
            <dependency>
                <groupId>io.jsonwebtoken</groupId>
                <artifactId>jjwt</artifactId>
                <version>${jwt.version}</version>
            </dependency>

            <!--httpclient-->
            <dependency>
                <groupId>org.apache.httpcomponents</groupId>
                <artifactId>httpclient</artifactId>
                <version>${httpclient.version}</version>
            </dependency>

        </dependencies>
    </dependencyManagement>


</project>
```



## 二、创建模块 srb-common



### 1. 创建 Maven 模块

在 Srb 父工程下，创建一个 Maven 模块

Group: **com.frankeleyn**

Artifact: **srb-common**



### 2.  配置 pom

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--lombok用来简化实体类：需要安装lombok插件-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
</dependencies>
```



## 三、创建模块 service-base



### 1. 创建 Maven 模块

Group: **com.frankeleyn**

Artifact: **service-base**



### 2. 配置 pom

```xml
<dependencies>
    <!-- 引入 common 项目-->
    <dependency>
        <groupId>com.frankeleyn</groupId>
        <artifactId>srb-common</artifactId>
        <version>1.0</version>
    </dependency>
    <!--swagger-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
    </dependency>
    <!--swagger ui-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
    </dependency>

    <!--mysql-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>
    <!--mybatis-plus 代码生成器-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-generator</artifactId>
    </dependency>
    <!-- Mybatis Plus 代码生成器模板引擎,  -->
    <dependency>
        <groupId>org.apache.velocity</groupId>
        <artifactId>velocity-engine-core</artifactId>
    </dependency>

</dependencies>
```



## 四、创建模块 service-core

### 1. 创建 Maven 模块

Group: **com.frankeleyn**

Artifact: **service-core**



### 2. 配置 pom

```xml
<dependencies>

    <dependency>
        <groupId>com.frankeleyn</groupId>
        <artifactId>service-base</artifactId>
        <version>1.0</version>
    </dependency>
    
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>

</dependencies>
```



## 五、启动应用程序

进入 **service-core** 项目中



### 1. 配置文件

创建 **application.properties**

```properties
# 端口号
server.port= 8110

# ==================== 数据源设置 =========================
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/srb_core?serverTimezone=GMT%2B8&characterEncoding=utf-8&useSSL=false
spring.datasource.username=root
spring.datasource.password=123456

# ================ mybatis 配置 =========================
# 驼峰命名
mybatis-plus.configuration.map-underscore-to-camel-case=true
# 扫描映射配置文件
mybatis-plus.mapper-locations=classpath:mapper/*Mapper.xml
# 打印 sql
mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```



### 2. 创建启动类

```java
package com.frankeleyn.srb.core;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * @author Frankeleyn
 * @date 2022/1/21 11:53
 */
@SpringBootApplication
public class ServiceCoreApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServiceCoreApplication.class, args);
    }
}
```



### 3. 创建 Mybatis Plus 配置文件

创建一个 **config** 包，创建类 **MybatisPlusConfig**

```java
package com.frankeleyn.srb.core.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.OptimisticLockerInnerInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.annotation.EnableTransactionManagement;

/**
 * @author Frankeleyn
 * @date 2022/1/17 15:22
 */
@Configuration
@EnableTransactionManagement
@MapperScan("com.frankeleyn.srb.core.mapper")
public class MybatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // 将分页插件放入容器
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        // 添加乐观锁插件
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return interceptor;
    }
}
```





## 六、代码生成器



### 1. 创建数据库

创建数据库 **srb_core**

并执行 sql 脚本初始化数据结构和数据



### 2. 创建代码生成器

在 **test** 目录中创建测试用例，并执行

```java
package com.frankeleyn.srb.core;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.generator.AutoGenerator;
import com.baomidou.mybatisplus.generator.config.DataSourceConfig;
import com.baomidou.mybatisplus.generator.config.GlobalConfig;
import com.baomidou.mybatisplus.generator.config.PackageConfig;
import com.baomidou.mybatisplus.generator.config.StrategyConfig;
import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

/**
 * @author Frankeleyn
 * @date 2022/1/21 14:03
 */
@SpringBootTest
public class GeneratorTest {

    @Test
    public void generate() {
        // 创建 mp 代码生成器
        AutoGenerator autoGenerator = new AutoGenerator();

        // 1 全局配置, 如命名规则，主键策略等
        GlobalConfig gc = new GlobalConfig();
        String projectPath = System.getProperty("user.dir");
        gc.setOutputDir(projectPath + "/src/main/java");
        gc.setAuthor("Frankeleyn");
        // 生成后是否打开资源管理器
        gc.setOpen(false);
        // 去掉Service接口的首字母I
        gc.setServiceName("%sService");
        // 主键策略
        gc.setIdType(IdType.AUTO);
        // 开启Swagger2模式
        gc.setSwagger2(true); 
        autoGenerator.setGlobalConfig(gc);

        // 2 数据源配置
        DataSourceConfig dataSourceConfig = new DataSourceConfig();
        dataSourceConfig.setUrl("jdbc:mysql://localhost:3306/srb_core?serverTimezone=GMT%2B8&characterEncoding=utf-8&useSSL=false");
        dataSourceConfig.setUsername("root");
        dataSourceConfig.setPassword("123456");
        dataSourceConfig.setDriverName("com.mysql.cj.jdbc.Driver");
        dataSourceConfig.setDbType(DbType.MYSQL);
        autoGenerator.setDataSource(dataSourceConfig);

        // 3 生成映射代码类的包配置
        PackageConfig packageConfig = new PackageConfig();
        packageConfig.setParent("com.frankeleyn.srb.core");
        packageConfig.setEntity("pojo.entity");
        autoGenerator.setPackageInfo(packageConfig);

        // 4 其他配置，如下划线，是否逻辑删除等
        StrategyConfig strategy = new StrategyConfig();
        //数据库表映射到实体的命名策略
        strategy.setNaming(NamingStrategy.underline_to_camel);
        //数据库表字段映射到实体的命名策略
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        // lombok, 就是添加一个 @Data
        strategy.setEntityLombokModel(true);
        //逻辑删除字段名
        strategy.setLogicDeleteFieldName("is_deleted");
        //去掉布尔值的is_前缀（确保tinyint(1)）
        strategy.setEntityBooleanColumnRemoveIsPrefix(true);
        //restful api风格控制器
        strategy.setRestControllerStyle(true); 
        autoGenerator.setStrategy(strategy);

        // 执行 mp 代码生成器
        autoGenerator.execute();
    }
}
```

### 3. 执行结果

![自动生成](./img/01/generator.png)





# 02-积分等级 CRUD



## 一、积分等级列表接口

### 1. 编写积分等级管理接口

在 **controller** 包中新建 **admin** 包，将自动生成的类 **IntegralGradeController** 移动到该包

```java
@CrossOrigin
@RestController
@RequestMapping("/admin/core/integralGrade")
public class IntegralGradeController {

    @Autowired
    private IntegralGradeService integralGradeService;

    @GetMapping("/list")
    public List<IntegralGrade> findAll() {
        return integralGradeService.list();
    }
    
    @DeleteMapping("/remove/{id}")
    public boolean removeById(@PathVariable Long id) {
        return integralGradeService.removeById(id);
    }
    
    @PostMapping("/save")
    public boolean save(@ReqestBody IntegralGrade integralGrade ) {
        return integralGradeService.save(integralGrade);
    }
    
    @PutMapping("/update")
    public boolean update(@ReqestBody IntegralGrade integralGrade ) {
        return integralGradeService.updateById(integralGrade);
    }
    
}
```



### 2. 测试

访问：http://localhost:8110/admin/core/integralGrade/list 查看 json 结果



## 二、配置 Swagger2

Swagger 是一个根据接口自动生成 api 文档和对应测试的 web 页面



### 1. Swagger2 配置文件

新建 **config** 文件夹，然后新建 **Swagger2Config** 类

```java
package com.frankeleyn.srb.core.config;

import com.google.common.base.Predicates;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

/**
 * @author Frankeleyn
 * @date 2022/1/21 15:03
 */
@EnableSwagger2
@Configuration
public class Swagger2Config {

    @Bean
    public Docket coreApiConfig() {
        Docket docket = new Docket(DocumentationType.SWAGGER_2)
                  .apiInfo(adminApiInfo())
                  .groupName("adminApi")
                  .select()
                   // 扫描 Controller 下面的 admin 包
                  .paths(Predicates.and(PathSelectors.regex("/admin/.*")))
                  .build();
        return docket;
    }

    private ApiInfo adminApiInfo(){

        return new ApiInfoBuilder()
                .title("尚融宝后台管理系统-API文档")
                .description("本文档描述了尚融宝后台管理系统接口")
                .version("1.0")
                .contact(new Contact("Frankeleyn", "https://githubfast.com/Frankeleyns/", "2582726641@qq.com"))
                .build();
    }

}
```



### 2. 移动 Controller

在 **controller** 包下，新建 **admin** 包，将 **IntegralGradeController** 移动到 admin 文件夹下

![移动 Controller](./img/01/02-2-2-1.png)



### 3. Swagger 常用注解

**实体类注解：**entity的实体类中可以添加一些自定义设置

```java
@ApiModelProperty(value = "创建时间", example = "2019-01-01 8:00:00")
private LocalDateTime createTime;

@ApiModelProperty(value = "更新时间", example = "2019-01-01 8:00:00")
private LocalDateTime updateTime;
```



**controller** 注解

定义在类上：

```java
@Api(tags = "积分等级管理 Api")
```

定义在方法上：

```java
@ApiOperation(value = "根据 id 删除积分等级", notes = "逻辑删除")
```

定义在参数上：

```java
@ApiParam(value = "数据id", required = true, example = "100")
```



### 4. 查看 Swagger 文档

重启服务器查看接口文档：http://localhost:8110/swagger-ui.html

![swaager 文档](./img/01/swagger.png)



# 03-统一返回结果



## 一、介绍

通常项目中我们会将响应结果封装成 json 返回，一般我们会将所有接口的数据格式统一， 使前端工程师调用我们项目的外部接口更一致。

一般情况下，统一返回数据格式没有固定的格式，只要能描述清楚返回的数据状态以及要返回的具体数据就可以。但是一般会包含**状态码、返回消息、数据**这三部分内容：

```json
{
   "code" : 0,
    "message" : "success",
    "data" : "数据"
}
```



## 二、定义统一返回结果



### 1. 创建枚举

在 **srb-common** 项目下，新建 **result** 包，创建枚举类 **ReponseEnum**

```java
package com.frankeleyn.common.result;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.ToString;

/**
 * @author Frankeleyn
 * @date 2022/1/21 15:38
 */
@Getter
@AllArgsConstructor
@ToString
public enum ResponseEnum {

    SUCCESS(0, "成功"),
    ERROR(-1, "服务器内部错误");

    // 响应状态码
    private Integer code;
    // 响应信息
    private String message;
}
```



### 2、定义统一结果类

```java
package com.frankeleyn.common.result;

import lombok.Data;

import java.util.HashMap;
import java.util.Map;

/**
 * @author Frankeleyn
 * @date 2022/1/21 15:38
 */
@Data
public class R {

    private Integer code;

    private String message;

    private Map<String, Object> data = new HashMap();

    /**
     * 构造器私有
     */
    private R(){}

    /**
     * 返回成功
     */
    public static R ok(){
        R r = new R();
        r.setCode(ResponseEnum.SUCCESS.getCode());
        r.setMessage(ResponseEnum.SUCCESS.getMessage());
        return r;
    }

    public static R ok(String message) {
        return ok().message(message);
    }
    
    public static R ok(String key, Object value) {
        return ok().data(key, value);
    }

    /**
     * 返回失败
     */
    public static R error(){
        R r = new R();
        r.setCode(ResponseEnum.ERROR.getCode());
        r.setMessage(ResponseEnum.ERROR.getMessage());
        return r;
    }

    /**
     * 设置特定结果
     */
    public static R setResult(ResponseEnum responseEnum){
        R r = new R();
        r.setCode(responseEnum.getCode());
        r.setMessage(responseEnum.getMessage());
        return r;
    }

    public R message(String message){
        this.setMessage(message);
        return this;
    }

    public R code(Integer code){
        this.setCode(code);
        return this;
    }

    public R data(String key, Object value){
        this.data.put(key, value);
        return this;
    }

    public R data(Map<String, Object> map){
        this.setData(map);
        return this;
    }
}
```



## 三、使用统一返回结果

修改 **IntegralGradeController** 中的方法



### 1. 修改 findAll

```java
@ApiOperation("获取积分等级列表")
@GetMapping("/list")
public R findAll() {
    List<IntegralGrade> integralGradeList = integralGradeService.list();
    return R.ok("integralGradeList", integralGradeList);
}
```



### 2. 修改 removeById

```java
@ApiOperation(value = "根据 id 删除积分等级", notes = "逻辑删除")
@DeleteMapping("/remove/{id}")
public R removeById(@ApiParam("积分等级 id") @PathVariable Long id) {
    boolean remove = integralGradeService.removeById(id);
    if (remove)
        return R.ok("删除积分等级成功");
    else
        return R.error("删除积分等级失败");
}
```



### 3. 修改 save

```java
@ApiOperation("新增积分等级")
@PostMapping("/save")
public R save(@ApiParam("积分等级对象") @RequestBody IntegralGrade integralGrade) {
    boolean save = integralGradeService.save(integralGrade);
    if (save)
        return R.ok("新增积分等级成功");
    else
        return R.error("新增积分等级失败");
}
```



### 4. 修改 update

```java
@ApiOperation("修改积分等级")
@PutMapping("/update")
public R updateById(@ApiParam("积分等级对象") @RequestBody IntegralGrade integralGrade) {
    boolean update = integralGradeService.updateById(integralGrade);
    if (update)
        return R.ok("修改积分等级成功");
    else
        return R.error("修改积分等级失败");
}
```



### 5. 根据 id 查询

```java
@ApiOperation("根据 id 查询积分等级")
@GetMapping("/get/{id}")
public R findById(@ApiParam("积分等级 id") @PathVariable Long id) {
    IntegralGrade integralGrade = integralGradeService.getById(id);
    if (Objects.nonNull(integralGrade)) 
        return R.ok("integralGrade", integralGrade);
    else 
        return R.error("未查询到积分等级");
}
```





# 04-统一异常处理



## 一、介绍

在接口发生异常时，一般是在 **controller** 抛出 **exception** 异常时，通过 **aop** 的异常通知处理接口的返回结果的全局设置，叫 **统一异常处理**。
